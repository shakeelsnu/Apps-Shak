<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Book - Multi-Currency Ledger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .nav-active { color: #2563eb; }
        .nav-inactive { color: #9ca3af; }
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="max-w-md mx-auto bg-white min-h-screen flex flex-col relative shadow-2xl">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 sticky top-0 z-50">
        <div class="flex justify-between items-center">
            <div>
                <h1 id="view-title" class="text-xl font-bold">Shop Book</h1>
                <p id="auth-status" class="text-[10px] opacity-80">Offline Mode</p>
            </div>
            <div class="flex items-center gap-3">
                <select id="currency-select" onchange="updateCurrency()" class="bg-blue-700 text-xs rounded px-2 py-1 border-none outline-none">
                    <option value="USD">USD ($)</option>
                    <option value="LKR">LKR (Rs)</option>
                    <option value="INR">INR (₹)</option>
                    <option value="EUR">EUR (€)</option>
                    <option value="GBP">GBP (£)</option>
                </select>
                <div class="flex gap-2">
                    <input type="file" id="import-input" class="hidden" accept=".json" onchange="importData(event)">
                    <button onclick="document.getElementById('import-input').click()" title="Upload Backup">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                    </button>
                    <button onclick="exportData()" title="Download Backup">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app-content" class="flex-1 p-4 mb-20 overflow-y-auto">
        <!-- Initial Skeleton Dashboard -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 animate-pulse">
                <div class="h-2 w-16 bg-gray-200 rounded mb-2"></div>
                <div class="h-6 w-24 bg-gray-300 rounded"></div>
            </div>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 animate-pulse">
                <div class="h-2 w-16 bg-gray-200 rounded mb-2"></div>
                <div class="h-6 w-24 bg-gray-300 rounded"></div>
            </div>
        </div>
        <p class="text-center text-xs text-gray-400">Connecting to secure storage...</p>
    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200 flex justify-around p-3 z-50">
        <button onclick="switchView('dashboard')" class="nav-btn flex flex-col items-center nav-active" data-view="dashboard">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
            <span class="text-[10px]">Home</span>
        </button>
        <button onclick="switchView('sales')" class="nav-btn flex flex-col items-center nav-inactive" data-view="sales">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" /><path d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9z" /></svg>
            <span class="text-[10px]">Sales</span>
        </button>
        <button onclick="switchView('customers')" class="nav-btn flex flex-col items-center nav-inactive" data-view="customers">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a7 7 0 00-7 7v1h12v-1a7 7 0 00-7-7z" /></svg>
            <span class="text-[10px]">Credit</span>
        </button>
        <button onclick="switchView('inventory')" class="nav-btn flex flex-col items-center nav-inactive" data-view="inventory">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" /></svg>
            <span class="text-[10px]">Stock</span>
        </button>
    </nav>

    <!-- Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-xl w-full max-w-sm p-6 max-h-[90vh] overflow-y-auto"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const currencySymbols = { USD: '$', LKR: 'Rs', INR: '₹', EUR: '€', GBP: '£' };

        window.state = {
            sales: [],
            customers: [],
            inventory: [],
            settings: { currency: 'USD' },
            currentView: 'dashboard',
            user: null
        };

        let db, auth, appId;

        const initApp = async () => {
            try {
                // Show immediate shell
                refreshUI();

                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'shop-book-pro';

                onAuthStateChanged(auth, (user) => {
                    window.state.user = user;
                    const statusEl = document.getElementById('auth-status');
                    if (user) {
                        if (statusEl) statusEl.innerText = `Online: ${user.uid.substring(0,6)}`;
                        setupListeners(user.uid);
                    }
                });

                // Robust Auth with Exponential Backoff
                const performAuth = async (retries = 0) => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        if (retries < 3) {
                            setTimeout(() => performAuth(retries + 1), Math.pow(2, retries) * 1000);
                        } else {
                            document.getElementById('auth-status').innerText = "Auth Error - Offline";
                        }
                    }
                };

                performAuth();
            } catch (err) {
                console.error("Critical Init Error:", err);
                refreshUI(); // Fallback to local UI
            }
        };

        function setupListeners(uid) {
            onSnapshot(doc(db, 'artifacts', appId, 'users', uid, 'settings', 'prefs'), (snapshot) => {
                if (snapshot.exists()) {
                    window.state.settings = snapshot.data();
                    const select = document.getElementById('currency-select');
                    if (select) select.value = window.state.settings.currency || 'USD';
                }
                refreshUI();
            }, (err) => console.warn("Snapshot error:", err));

            onSnapshot(collection(db, 'artifacts', appId, 'users', uid, 'sales'), (snap) => {
                window.state.sales = snap.docs.map(d => ({id: d.id, ...d.data()}));
                refreshUI();
            }, (err) => console.warn("Snapshot error:", err));

            onSnapshot(collection(db, 'artifacts', appId, 'users', uid, 'customers'), (snap) => {
                window.state.customers = snap.docs.map(d => ({id: d.id, ...d.data()}));
                refreshUI();
            }, (err) => console.warn("Snapshot error:", err));

            onSnapshot(collection(db, 'artifacts', appId, 'users', uid, 'inventory'), (snap) => {
                window.state.inventory = snap.docs.map(d => ({id: d.id, ...d.data()}));
                refreshUI();
            }, (err) => console.warn("Snapshot error:", err));
        }

        window.switchView = (view) => {
            window.state.currentView = view;
            refreshUI();
        };

        window.updateCurrency = async () => {
            const select = document.getElementById('currency-select');
            const val = select.value;
            window.state.settings.currency = val;
            refreshUI();
            if (window.state.user) {
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'users', window.state.user.uid, 'settings', 'prefs'), { currency: val });
                } catch(e) {}
            }
        };

        function refreshUI() {
            const container = document.getElementById('app-content');
            const title = document.getElementById('view-title');
            if (!container || !title) return;

            const symbol = currencySymbols[window.state.settings.currency] || '$';

            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isActive = btn.dataset.view === window.state.currentView;
                btn.classList.toggle('nav-active', isActive);
                btn.classList.toggle('nav-inactive', !isActive);
            });

            if (window.state.currentView === 'dashboard') {
                title.innerText = "Dashboard";
                const today = new Date().toLocaleDateString();
                const todaySales = window.state.sales
                    .filter(s => new Date(s.date).toLocaleDateString() === today)
                    .reduce((acc, curr) => acc + (parseFloat(curr.amount) || 0), 0);
                const totalCredit = window.state.customers.reduce((acc, curr) => acc + (parseFloat(curr.balance) || 0), 0);

                container.innerHTML = `
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                            <p class="text-[10px] text-blue-600 font-bold uppercase">Today's Sales</p>
                            <p class="text-xl font-black text-blue-900">${symbol}${todaySales.toLocaleString()}</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                            <p class="text-[10px] text-red-600 font-bold uppercase">Total Debt</p>
                            <p class="text-xl font-black text-red-900">${symbol}${totalCredit.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-6">
                        <button onclick="openModal('addSale')" class="bg-white border p-3 rounded-lg flex flex-col items-center shadow-sm active:bg-gray-50">
                            <div class="text-green-500 mb-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 4v16m8-8H4"/></svg></div>
                            <span class="text-[9px] font-bold">New Sale</span>
                        </button>
                        <button onclick="openModal('addCustomer')" class="bg-white border p-3 rounded-lg flex flex-col items-center shadow-sm active:bg-gray-50">
                            <div class="text-blue-500 mb-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg></div>
                            <span class="text-[9px] font-bold">Customer</span>
                        </button>
                        <button onclick="openModal('addStock')" class="bg-white border p-3 rounded-lg flex flex-col items-center shadow-sm active:bg-gray-50">
                            <div class="text-purple-500 mb-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg></div>
                            <span class="text-[9px] font-bold">Stock</span>
                        </button>
                    </div>
                    <h3 class="font-bold text-sm text-gray-500 mb-2">Recent Sales</h3>
                    <div class="space-y-2">
                        ${window.state.sales.slice(-5).reverse().map(s => `
                            <div class="flex justify-between p-3 bg-white border rounded-lg shadow-sm">
                                <div><p class="text-sm font-bold">${s.item}</p><p class="text-[10px] text-gray-400">${new Date(s.date).toLocaleTimeString()}</p></div>
                                <p class="font-bold text-green-600">${symbol}${parseFloat(s.amount).toFixed(2)}</p>
                            </div>
                        `).join('') || '<p class="text-center text-xs text-gray-400 py-6">No sales recorded yet</p>'}
                    </div>
                `;
            } else if (window.state.currentView === 'sales') {
                title.innerText = "Sales History";
                container.innerHTML = `<div class="space-y-2">${window.state.sales.slice().reverse().map(s => `
                    <div class="flex justify-between items-center p-4 bg-white border rounded-xl shadow-sm">
                        <div><p class="font-bold">${s.item}</p><p class="text-xs text-gray-400">${new Date(s.date).toLocaleDateString()}</p></div>
                        <div class="text-right">
                            <p class="font-bold text-blue-600">${symbol}${parseFloat(s.amount).toFixed(2)}</p>
                            <button onclick="deleteDocHandler('sales', '${s.id}')" class="text-[10px] text-red-400 uppercase font-bold">Delete</button>
                        </div>
                    </div>
                `).join('') || '<p class="text-center text-gray-400 py-10">No records found</p>'}</div>`;
            } else if (window.state.currentView === 'customers') {
                title.innerText = "Credit Ledger";
                container.innerHTML = `<div class="space-y-2">${window.state.customers.map(c => `
                    <div class="flex justify-between items-center p-4 bg-white border rounded-xl shadow-sm">
                        <div><p class="font-bold">${c.name}</p><p class="text-xs text-gray-400">${c.phone || ''}</p></div>
                        <div class="text-right">
                            <p class="font-bold ${c.balance > 0 ? 'text-red-500' : 'text-green-600'}">${symbol}${Math.abs(c.balance).toFixed(2)}</p>
                            <div class="flex gap-1 mt-1">
                                <button onclick="adjustBalance('${c.id}', ${c.balance}, -1)" class="px-2 py-0.5 bg-green-50 text-green-600 text-[10px] rounded border">Paid</button>
                                <button onclick="adjustBalance('${c.id}', ${c.balance}, 1)" class="px-2 py-0.5 bg-red-50 text-red-600 text-[10px] rounded border">Debt</button>
                            </div>
                        </div>
                    </div>
                `).join('') || '<p class="text-center text-gray-400 py-10">No customer records</p>'}</div>`;
            } else if (window.state.currentView === 'inventory') {
                title.innerText = "Stock Inventory";
                container.innerHTML = `<div class="space-y-2">${window.state.inventory.map(i => `
                    <div class="flex justify-between items-center p-4 bg-white border rounded-xl shadow-sm">
                        <div><p class="font-bold">${i.name}</p><p class="text-xs text-gray-400">Price: ${symbol}${i.price}</p></div>
                        <div class="flex items-center gap-3">
                            <button onclick="adjustStock('${i.id}', ${i.qty}, -1)" class="w-8 h-8 bg-gray-100 rounded flex items-center justify-center">-</button>
                            <span class="font-bold w-6 text-center ${i.qty < 5 ? 'text-red-500' : ''}">${i.qty}</span>
                            <button onclick="adjustStock('${i.id}', ${i.qty}, 1)" class="w-8 h-8 bg-gray-100 rounded flex items-center justify-center">+</button>
                        </div>
                    </div>
                `).join('') || '<p class="text-center text-gray-400 py-10">No stock items</p>'}</div>`;
            }
        }

        window.openModal = (type) => {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            if (!overlay || !content) return;
            overlay.classList.remove('hidden');
            if(type === 'addSale') {
                content.innerHTML = `<h2 class="font-bold mb-4 text-gray-800">New Sale</h2><input id="m-item" placeholder="Item Name" class="w-full border p-2 mb-2 rounded focus:ring-2 focus:ring-blue-500 outline-none"><input id="m-amt" type="number" placeholder="Amount" class="w-full border p-2 mb-4 rounded focus:ring-2 focus:ring-blue-500 outline-none"><button onclick="saveNewSale()" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Add Sale</button><button onclick="closeModal()" class="w-full mt-2 text-gray-400 text-sm">Cancel</button>`;
            } else if(type === 'addCustomer') {
                content.innerHTML = `<h2 class="font-bold mb-4 text-gray-800">New Customer</h2><input id="m-name" placeholder="Full Name" class="w-full border p-2 mb-2 rounded focus:ring-2 focus:ring-blue-500 outline-none"><input id="m-bal" type="number" placeholder="Initial Debt" class="w-full border p-2 mb-4 rounded focus:ring-2 focus:ring-blue-500 outline-none"><button onclick="saveNewCustomer()" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Save Customer</button><button onclick="closeModal()" class="w-full mt-2 text-gray-400 text-sm">Cancel</button>`;
            } else if(type === 'addStock') {
                content.innerHTML = `<h2 class="font-bold mb-4 text-gray-800">Add Stock</h2><input id="m-pname" placeholder="Item Name" class="w-full border p-2 mb-2 rounded focus:ring-2 focus:ring-blue-500 outline-none"><input id="m-price" type="number" placeholder="Selling Price" class="w-full border p-2 mb-2 rounded focus:ring-2 focus:ring-blue-500 outline-none"><input id="m-qty" type="number" placeholder="Initial Quantity" class="w-full border p-2 mb-4 rounded focus:ring-2 focus:ring-blue-500 outline-none"><button onclick="saveNewStock()" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Add to Inventory</button><button onclick="closeModal()" class="w-full mt-2 text-gray-400 text-sm">Cancel</button>`;
            }
        };

        window.closeModal = () => document.getElementById('modal-overlay').classList.add('hidden');

        window.saveNewSale = async () => {
            const item = document.getElementById('m-item').value;
            const amount = document.getElementById('m-amt').value;
            if(!item || !amount || !window.state.user) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', window.state.user.uid, 'sales'), { item, amount: parseFloat(amount), date: new Date().toISOString() });
            closeModal();
        };

        window.saveNewCustomer = async () => {
            const name = document.getElementById('m-name').value;
            const balance = document.getElementById('m-bal').value || 0;
            if(!name || !window.state.user) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', window.state.user.uid, 'customers'), { name, balance: parseFloat(balance), phone: '' });
            closeModal();
        };

        window.saveNewStock = async () => {
            const name = document.getElementById('m-pname').value;
            const price = document.getElementById('m-price').value;
            const qty = document.getElementById('m-qty').value || 0;
            if(!name || !window.state.user) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', window.state.user.uid, 'inventory'), { name, price: parseFloat(price), qty: parseInt(qty) });
            closeModal();
        };

        window.adjustBalance = async (id, current, mult) => {
            const amt = prompt("Amount:");
            if(!amt || isNaN(amt) || !window.state.user) return;
            await updateDoc(doc(db, 'artifacts', appId, 'users', window.state.user.uid, 'customers', id), { balance: current + (parseFloat(amt) * mult) });
        };

        window.adjustStock = async (id, current, change) => {
            if(!window.state.user) return;
            await updateDoc(doc(db, 'artifacts', appId, 'users', window.state.user.uid, 'inventory', id), { qty: Math.max(0, current + change) });
        };

        window.deleteDocHandler = async (coll, id) => {
            if(confirm("Permanently delete?") && window.state.user) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', window.state.user.uid, coll, id));
            }
        };

        window.exportData = () => {
            const exportData = {
                sales: window.state.sales,
                customers: window.state.customers,
                inventory: window.state.inventory,
                settings: window.state.settings,
                exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `shop_book_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        };

        window.importData = (event) => {
            const file = event.target.files[0];
            if (!file || !window.state.user) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (!confirm("Import and merge data?")) return;
                    const uid = window.state.user.uid;
                    if (imported.settings) await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'settings', 'prefs'), imported.settings);
                    for (const s of (imported.sales || [])) { const {id, ...data} = s; await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'sales'), data); }
                    for (const c of (imported.customers || [])) { const {id, ...data} = c; await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'customers'), data); }
                    for (const i of (imported.inventory || [])) { const {id, ...data} = i; await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'inventory'), data); }
                    alert("Data Restored!");
                    window.location.reload();
                } catch (err) { alert("Invalid File"); }
            };
            reader.readAsText(file);
        };

        initApp();
    </script>
</body>
</html>
