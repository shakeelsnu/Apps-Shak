<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyTransactions - Book Keeping üìíüí∞üì¶</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
        body {
            background: #f0f4f8;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 16px;
            color: #1e293b;
        }
        .app-container {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 32px 32px 24px 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        /* Auth Pages */
        .auth-container {
            max-width: 400px;
            margin: 40px auto;
            padding: 32px;
            background: white;
            border-radius: 32px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }
        .auth-header {
            text-align: center;
            margin-bottom: 24px;
        }
        .auth-header h2 { color: #1a4a5f; font-size: 1.8rem; }
        .auth-header p { color: #64748b; font-size: 0.95rem; }
        .auth-input {
            width: 100%;
            padding: 16px 18px;
            margin: 8px 0;
            border: 1.5px solid #e2e8f0;
            border-radius: 30px;
            font-size: 1rem;
        }
        .auth-btn {
            background: #1a4a5f;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1.1rem;
            width: 100%;
            cursor: pointer;
            margin: 16px 0;
        }
        .auth-link {
            color: #1a4a5f;
            text-decoration: none;
            font-size: 0.95rem;
            cursor: pointer;
            display: inline-block;
            margin: 8px 0;
        }
        .auth-divider {
            text-align: center;
            margin: 20px 0;
            color: #94a3b8;
        }
        .error-message {
            color: #b91c1c;
            font-size: 0.9rem;
            margin: 8px 0;
            text-align: center;
        }
        .success-message {
            color: #0f7b4a;
            font-size: 0.9rem;
            margin: 8px 0;
            text-align: center;
        }
        /* Header */
        .app-header {
            background: linear-gradient(145deg, #0f2b3d, #1a4a5f);
            color: white;
            padding: 20px 24px;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        .app-header h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-welcome {
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(255,255,255,0.1);
            padding: 8px 16px;
            border-radius: 40px;
        }
        .logout-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.5);
            color: white;
            padding: 6px 16px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.2); }
        .date-day {
            font-size: 1rem;
            margin-top: 8px;
            opacity: 0.9;
        }
        /* Backup Bar */
        .backup-bar {
            background: #e9f2f5;
            padding: 12px 24px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #cbd5e1;
        }
        .backup-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .backup-btn {
            background: white;
            border: 1px solid #1a4a5f;
            color: #1a4a5f;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .backup-btn:hover { background: #1a4a5f; color: white; }
        /* Tabs */
        .feature-tabs {
            display: flex;
            flex-wrap: wrap;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 0 8px;
        }
        .tab-btn {
            padding: 16px 20px;
            background: transparent;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            color: #1a4a5f;
            border-bottom-color: #1a4a5f;
            background: rgba(26, 74, 95, 0.04);
        }
        .tab-content {
            display: none;
            padding: 24px;
        }
        .tab-content.active-content { display: block; }
        /* Cards */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .card {
            background: #ffffff;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.02);
            border: 1px solid #eef2f6;
        }
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #0f2b3d;
        }
        .summary-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1a4a5f;
        }
        .summary-label { font-size: 0.9rem; color: #64748b; }
        .input-group { margin-bottom: 12px; }
        input, textarea, select {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid #e2e8f0;
            border-radius: 18px;
            font-size: 0.95rem;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #1a4a5f;
            box-shadow: 0 0 0 3px rgba(26,74,95,0.1);
        }
        .btn {
            background: #1a4a5f;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }
        .btn-secondary {
            background: white;
            color: #1a4a5f;
            border: 1px solid #1a4a5f;
        }
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            width: auto;
        }
        .list-item {
            background: #f8fafc;
            border-radius: 18px;
            padding: 14px 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #eef2f6;
            cursor: pointer;
            transition: all 0.2s;
        }
        .list-item:hover {
            background: #e9f2f5;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .item-actions { display: flex; gap: 8px; align-items: center; }
        .delete-btn {
            background: #fee2e2;
            color: #b91c1c;
            border: none;
            padding: 6px 12px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .delete-btn:hover {
            background: #fecaca;
        }
        .badge {
            background: #d9e6ed;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.8rem;
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 28px;
            border-radius: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-content h3 {
            margin-bottom: 20px;
            color: #1a4a5f;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        .view-field {
            margin-bottom: 16px;
        }
        .view-field label {
            display: block;
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 4px;
        }
        .view-field .value {
            background: #f8fafc;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 1.1rem;
            border: 1px solid #e2e8f0;
        }
        .home-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }
        .stat-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 24px;
            text-align: center;
        }
        .recovery-hint {
            background: #e9f2f5;
            padding: 16px;
            border-radius: 18px;
            margin: 16px 0;
            font-size: 0.9rem;
        }
        .edit-input {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid #e2e8f0;
            border-radius: 16px;
            font-size: 1rem;
            margin-bottom: 12px;
        }
        .checkbox-view {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 12px 0;
        }
    </style>
</head>
<body>
<div id="app">
    <!-- AUTH SCREENS -->
    <div id="auth-screen" style="display: block;">
        <!-- LOGIN FORM -->
        <div id="login-form" class="auth-container">
            <div class="auth-header">
                <h2>üìíüí∞üì¶ MyTransactions</h2>
                <p>Book Keeping App</p>
            </div>
            <input type="email" id="login-email" class="auth-input" placeholder="Email" value="demo@user.com">
            <input type="password" id="login-password" class="auth-input" placeholder="Password" value="password123">
            <div id="login-error" class="error-message"></div>
            <button class="auth-btn" id="login-btn">üîê Login</button>
            <div style="text-align: center;">
                <a class="auth-link" id="show-forgot">üîë Forgot Password?</a>
                <span class="auth-divider">‚Ä¢</span>
                <a class="auth-link" id="show-signup">üìù Create Account</a>
            </div>
            <div class="recovery-hint">
                <strong>Demo:</strong> Use any email with password "password123"<br>
                Or create a new account
            </div>
        </div>

        <!-- SIGNUP FORM -->
        <div id="signup-form" class="auth-container" style="display: none;">
            <div class="auth-header">
                <h2>Create Account</h2>
                <p>MyTransactions Book Keeping</p>
            </div>
            <input type="email" id="signup-email" class="auth-input" placeholder="Email">
            <input type="password" id="signup-password" class="auth-input" placeholder="Password (min 4 chars)">
            <input type="password" id="signup-confirm" class="auth-input" placeholder="Confirm Password">
            <div id="signup-error" class="error-message"></div>
            <button class="auth-btn" id="signup-btn">üìù Create Account</button>
            <div style="text-align: center;">
                <a class="auth-link" id="show-login-from-signup">‚Üê Back to Login</a>
            </div>
        </div>

        <!-- FORGOT PASSWORD FORM -->
        <div id="forgot-form" class="auth-container" style="display: none;">
            <div class="auth-header">
                <h2>Recover Password</h2>
                <p>We'll simulate email recovery</p>
            </div>
            <input type="email" id="forgot-email" class="auth-input" placeholder="Your Email">
            <div id="forgot-message" class="success-message"></div>
            <div id="forgot-error" class="error-message"></div>
            <button class="auth-btn" id="forgot-btn">üìß Send Recovery</button>
            <div style="text-align: center;">
                <a class="auth-link" id="show-login-from-forgot">‚Üê Back to Login</a>
            </div>
        </div>
    </div>

    <!-- MAIN APP (shown after login) -->
    <div id="main-app" style="display: none;">
        <div class="app-header">
            <div class="header-top">
                <h1><span>üìíüí∞üì¶</span> MyTransactions</h1>
                <div class="user-welcome">
                    <span id="welcome-user">üë§ Welcome</span>
                    <button class="logout-btn" id="logout-btn">üö™ Logout</button>
                </div>
            </div>
            <div class="date-day" id="current-date-day"></div>
        </div>

        <!-- Backup Bar -->
        <div class="backup-bar">
            <span>üíæ Backup & Restore</span>
            <div class="backup-actions">
                <button class="backup-btn" id="backup-download">‚¨áÔ∏è Download Backup</button>
                <input type="file" id="restore-file" accept=".json" style="display: none;">
                <button class="backup-btn" id="backup-upload">‚¨ÜÔ∏è Restore Backup</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="feature-tabs">
            <button class="tab-btn active" data-tab="home"><span>üè†</span> Home</button>
            <button class="tab-btn" data-tab="credit"><span>üìí</span> Credit Book</button>
            <button class="tab-btn" data-tab="cash"><span>üí∞</span> Cash Book</button>
            <button class="tab-btn" data-tab="stock"><span>üì¶</span> Stock Book</button>
            <button class="tab-btn" data-tab="invoice"><span>üßæ</span> Invoice</button>
        </div>

        <!-- HOME TAB -->
        <div id="home-tab" class="tab-content active-content">
            <div class="card">
                <div class="card-title">üìä Business Overview</div>
                <div class="home-stats" id="home-stats">
                    <div class="stat-card"><span class="summary-label">Total Credit</span><div class="summary-number" id="home-total-credit">0</div></div>
                    <div class="stat-card"><span class="summary-label">Cash Balance</span><div class="summary-number" id="home-cash-balance">0</div></div>
                    <div class="stat-card"><span class="summary-label">Stock Items</span><div class="summary-number" id="home-stock-items">0</div></div>
                    <div class="stat-card"><span class="summary-label">Stock Value</span><div class="summary-number" id="home-stock-value">0</div></div>
                </div>
            </div>
        </div>

        <!-- CREDIT BOOK TAB -->
        <div id="credit-tab" class="tab-content">
            <div class="feature-grid">
                <div class="card">
                    <div class="card-title">üìã New Credit</div>
                    <input type="text" id="credit-customer" placeholder="Customer name">
                    <input type="number" id="credit-amount" placeholder="Amount (LKR)">
                    <input type="text" id="credit-note" placeholder="Note">
                    <button class="btn" id="addCreditBtn">‚ûï Add Credit</button>
                </div>
                <div class="card">
                    <div class="card-title">üìä Summary</div>
                    <div style="display: flex; justify-content: space-between;">
                        <div><span class="summary-label">Total</span><div class="summary-number" id="totalCredit">0</div></div>
                        <div><span class="summary-label">Collected</span><div class="summary-number" id="collectedCredit">0</div></div>
                        <div><span class="summary-label">Remaining</span><div class="summary-number" id="remainingCredit">0</div></div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">üìú Credit Entries (click to view/edit)</div>
                <div id="creditList"></div>
            </div>
        </div>

        <!-- CASH BOOK TAB -->
        <div id="cash-tab" class="tab-content">
            <div class="feature-grid">
                <div class="card">
                    <div class="card-title">‚ûï Add Transaction</div>
                    <select id="cash-type"><option value="income">üí∞ Income</option><option value="expense">üí∏ Expense</option></select>
                    <input type="number" id="cash-amount" placeholder="Amount">
                    <input type="text" id="cash-desc" placeholder="Description">
                    <button class="btn" id="addCashBtn">Add Entry</button>
                </div>
                <div class="card">
                    <div class="card-title">üìà Cash Flow</div>
                    <div style="display: flex; justify-content: space-around;">
                        <div><span class="summary-label">Today</span><div class="summary-number" id="todayCash">0</div></div>
                        <div><span class="summary-label">Balance</span><div class="summary-number" id="balanceCash">0</div></div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">üìÜ Transactions (click to view/edit)</div>
                <div id="cashList"></div>
            </div>
        </div>

        <!-- STOCK BOOK TAB -->
        <div id="stock-tab" class="tab-content">
            <div class="feature-grid">
                <div class="card">
                    <div class="card-title">üì¶ Add Stock</div>
                    <input type="text" id="stock-name" placeholder="Item name">
                    <input type="number" id="stock-qty" placeholder="Quantity">
                    <input type="number" id="stock-price" placeholder="Cost price">
                    <button class="btn" id="addStockBtn">Add to Stock</button>
                </div>
                <div class="card">
                    <div class="card-title">üìä Stock Value</div>
                    <div><span class="summary-label">Total Items</span><div class="summary-number" id="totalItems">0</div></div>
                    <div><span class="summary-label">Est. Value</span><div class="summary-number" id="stockValue">0</div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">üìã Current Stock (click to view/edit)</div>
                <div id="stockList"></div>
                <div style="margin-top: 16px;">
                    <input type="text" id="sell-item-name" placeholder="Item to sell">
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="sell-qty" placeholder="Qty">
                        <button class="btn-small" id="sellStockBtn">Sell</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- INVOICE TAB -->
        <div id="invoice-tab" class="tab-content">
            <div class="feature-grid">
                <div class="card">
                    <div class="card-title">üßæ Create Invoice</div>
                    <input type="text" id="invoice-customer" placeholder="Customer">
                    <textarea id="invoice-items" placeholder="Items" rows="2"></textarea>
                    <input type="number" id="invoice-total" placeholder="Total">
                    <button class="btn" id="createInvoiceBtn">Generate</button>
                </div>
                <div class="card">
                    <div class="card-title">üìÑ Last Invoice</div>
                    <div id="lastInvoicePreview"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW/EDIT MODAL -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">View Entry</h3>
            <div id="modal-body"></div>
            <div class="modal-actions">
                <button class="btn-small" id="modal-save">üíæ Save Changes</button>
                <button class="btn-small btn-secondary" id="modal-close">Close</button>
                <button class="btn-small delete-btn" id="modal-delete">üóëÔ∏è Delete</button>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 16px;">‚ö†Ô∏è Confirm Delete</h3>
            <p id="delete-message">Are you sure?</p>
            <div class="modal-actions">
                <button class="btn-small" id="confirmDelete">Yes, Delete</button>
                <button class="btn-small btn-secondary" id="cancelDelete">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        // ---------- USER MANAGEMENT ----------
        let users = {};

        // Load users from localStorage
        function loadUsers() {
            const saved = localStorage.getItem('mytransactions_users');
            if (saved) {
                try { users = JSON.parse(saved); } catch { users = {}; }
            } else {
                // Create demo user
                users = {
                    'demo@user.com': {
                        password: 'password123',
                        data: {
                            creditData: [],
                            cashData: [],
                            stockData: [],
                            lastInvoice: null
                        }
                    }
                };
                saveUsers();
            }
        }

        function saveUsers() {
            localStorage.setItem('mytransactions_users', JSON.stringify(users));
        }

        // Current logged in user
        let currentUser = null;
        let userData = { creditData: [], cashData: [], stockData: [], lastInvoice: null };

        // Load user data into memory
        function loadUserData(email) {
            if (users[email] && users[email].data) {
                userData.creditData = users[email].data.creditData || [];
                userData.cashData = users[email].data.cashData || [];
                userData.stockData = users[email].data.stockData || [];
                userData.lastInvoice = users[email].data.lastInvoice || null;
            } else {
                userData = { creditData: [], cashData: [], stockData: [], lastInvoice: null };
                if (users[email]) {
                    users[email].data = userData;
                    saveUsers();
                }
            }
        }

        // Save current user's data back to users object
        function saveCurrentUserData() {
            if (currentUser && users[currentUser]) {
                users[currentUser].data = {
                    creditData: userData.creditData,
                    cashData: userData.cashData,
                    stockData: userData.stockData,
                    lastInvoice: userData.lastInvoice
                };
                saveUsers();
            }
        }

        // Initialize
        loadUsers();

        // DOM Elements
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const forgotForm = document.getElementById('forgot-form');
        const welcomeSpan = document.getElementById('welcome-user');

        // Check for remembered user
        const remembered = localStorage.getItem('mytransactions_remember');
        if (remembered && users[remembered]) {
            currentUser = remembered;
            loadUserData(currentUser);
            authScreen.style.display = 'none';
            mainApp.style.display = 'block';
            welcomeSpan.innerText = `üë§ ${currentUser.split('@')[0]}`;
            updateDateDay();
            renderAll();
        } else {
            authScreen.style.display = 'block';
            mainApp.style.display = 'none';
        }

        // ---------- AUTH NAVIGATION ----------
        document.getElementById('show-signup').addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
            forgotForm.style.display = 'none';
            clearErrors();
        });

        document.getElementById('show-forgot').addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'none';
            signupForm.style.display = 'none';
            forgotForm.style.display = 'block';
            clearErrors();
        });

        document.getElementById('show-login-from-signup').addEventListener('click', (e) => {
            e.preventDefault();
            signupForm.style.display = 'none';
            loginForm.style.display = 'block';
            forgotForm.style.display = 'none';
            clearErrors();
        });

        document.getElementById('show-login-from-forgot').addEventListener('click', (e) => {
            e.preventDefault();
            forgotForm.style.display = 'none';
            loginForm.style.display = 'block';
            clearErrors();
        });

        function clearErrors() {
            document.getElementById('login-error').innerText = '';
            document.getElementById('signup-error').innerText = '';
            document.getElementById('forgot-error').innerText = '';
            document.getElementById('forgot-message').innerText = '';
        }

        // ---------- LOGIN ----------
        document.getElementById('login-btn').addEventListener('click', () => {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');

            if (!email || !password) {
                errorEl.innerText = 'Email and password required';
                return;
            }

            if (!users[email]) {
                errorEl.innerText = 'User not found. Please sign up.';
                return;
            }

            if (users[email].password !== password) {
                errorEl.innerText = 'Incorrect password';
                return;
            }

            // Login successful
            currentUser = email;
            loadUserData(email);
            
            localStorage.setItem('mytransactions_remember', email);

            authScreen.style.display = 'none';
            mainApp.style.display = 'block';
            welcomeSpan.innerText = `üë§ ${email.split('@')[0]}`;
            updateDateDay();
            renderAll();
        });

        // ---------- SIGNUP ----------
        document.getElementById('signup-btn').addEventListener('click', () => {
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('signup-confirm').value;
            const errorEl = document.getElementById('signup-error');

            if (!email || !password || !confirm) {
                errorEl.innerText = 'All fields required';
                return;
            }
            if (password.length < 4) {
                errorEl.innerText = 'Password must be at least 4 characters';
                return;
            }
            if (password !== confirm) {
                errorEl.innerText = 'Passwords do not match';
                return;
            }
            if (users[email]) {
                errorEl.innerText = 'Email already registered. Please login.';
                return;
            }

            users[email] = {
                password: password,
                data: { creditData: [], cashData: [], stockData: [], lastInvoice: null }
            };
            saveUsers();

            currentUser = email;
            loadUserData(email);
            localStorage.setItem('mytransactions_remember', email);

            authScreen.style.display = 'none';
            mainApp.style.display = 'block';
            welcomeSpan.innerText = `üë§ ${email.split('@')[0]}`;
            updateDateDay();
            renderAll();
        });

        // ---------- FORGOT PASSWORD ----------
        document.getElementById('forgot-btn').addEventListener('click', () => {
            const email = document.getElementById('forgot-email').value.trim();
            const messageEl = document.getElementById('forgot-message');
            const errorEl = document.getElementById('forgot-error');

            if (!email) {
                errorEl.innerText = 'Email required';
                messageEl.innerText = '';
                return;
            }

            if (!users[email]) {
                errorEl.innerText = 'Email not registered';
                messageEl.innerText = '';
                return;
            }

            messageEl.innerText = `üìß Demo: Password for ${email} is "${users[email].password}" (simulated email)`;
            errorEl.innerText = '';
        });

        // ---------- LOGOUT ----------
        document.getElementById('logout-btn').addEventListener('click', () => {
            saveCurrentUserData();
            
            currentUser = null;
            localStorage.removeItem('mytransactions_remember');
            authScreen.style.display = 'block';
            mainApp.style.display = 'none';
            
            loginForm.style.display = 'block';
            signupForm.style.display = 'none';
            forgotForm.style.display = 'none';
            clearErrors();
        });

        // ---------- VIEW/EDIT MODAL ----------
        const viewModal = document.getElementById('viewModal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalSave = document.getElementById('modal-save');
        const modalClose = document.getElementById('modal-close');
        const modalDelete = document.getElementById('modal-delete');
        
        let currentViewItem = null; // { type, index, data }

        function openViewModal(type, index) {
            let item = null;
            if (type === 'credit') item = userData.creditData[index];
            else if (type === 'cash') item = userData.cashData[index];
            else if (type === 'stock') item = userData.stockData[index];

            if (!item) return;

            currentViewItem = { type, index, data: { ...item } }; // copy for editing
            
            modalTitle.innerText = `View/Edit ${type.charAt(0).toUpperCase() + type.slice(1)} Entry`;
            
            // Build form based on type
            let html = '';
            
            if (type === 'credit') {
                html = `
                    <div class="view-field">
                        <label>Customer</label>
                        <input type="text" id="edit-customer" class="edit-input" value="${item.customer || ''}">
                    </div>
                    <div class="view-field">
                        <label>Amount (LKR)</label>
                        <input type="number" id="edit-amount" class="edit-input" value="${item.amount || 0}">
                    </div>
                    <div class="view-field">
                        <label>Note</label>
                        <input type="text" id="edit-note" class="edit-input" value="${item.note || ''}">
                    </div>
                    <div class="checkbox-view">
                        <input type="checkbox" id="edit-collected" ${item.collected ? 'checked' : ''}>
                        <label>Collected</label>
                    </div>
                    <div class="view-field">
                        <label>Date</label>
                        <div class="value">${new Date(item.timestamp).toLocaleString()}</div>
                    </div>
                `;
            } else if (type === 'cash') {
                html = `
                    <div class="view-field">
                        <label>Type</label>
                        <select id="edit-type" class="edit-input">
                            <option value="income" ${item.type === 'income' ? 'selected' : ''}>üí∞ Income</option>
                            <option value="expense" ${item.type === 'expense' ? 'selected' : ''}>üí∏ Expense</option>
                        </select>
                    </div>
                    <div class="view-field">
                        <label>Amount (LKR)</label>
                        <input type="number" id="edit-amount" class="edit-input" value="${item.amount || 0}">
                    </div>
                    <div class="view-field">
                        <label>Description</label>
                        <input type="text" id="edit-desc" class="edit-input" value="${item.desc || ''}">
                    </div>
                    <div class="view-field">
                        <label>Date</label>
                        <div class="value">${new Date(item.timestamp).toLocaleString()}</div>
                    </div>
                `;
            } else if (type === 'stock') {
                html = `
                    <div class="view-field">
                        <label>Item Name</label>
                        <input type="text" id="edit-name" class="edit-input" value="${item.name || ''}">
                    </div>
                    <div class="view-field">
                        <label>Quantity</label>
                        <input type="number" id="edit-qty" class="edit-input" value="${item.qty || 0}">
                    </div>
                    <div class="view-field">
                        <label>Cost Price (per unit)</label>
                        <input type="number" id="edit-price" class="edit-input" value="${item.price || 0}">
                    </div>
                `;
            }

            modalBody.innerHTML = html;
            viewModal.style.display = 'flex';
        }

        // Save edited data
        modalSave.addEventListener('click', () => {
            if (!currentViewItem) return;

            const { type, index } = currentViewItem;

            if (type === 'credit') {
                const customer = document.getElementById('edit-customer')?.value.trim();
                const amount = parseFloat(document.getElementById('edit-amount')?.value);
                const note = document.getElementById('edit-note')?.value.trim();
                const collected = document.getElementById('edit-collected')?.checked || false;

                if (!customer || isNaN(amount) || amount <= 0) {
                    alert('Invalid customer or amount');
                    return;
                }

                userData.creditData[index] = {
                    ...userData.creditData[index],
                    customer,
                    amount,
                    note,
                    collected
                };
            } else if (type === 'cash') {
                const typeVal = document.getElementById('edit-type')?.value;
                const amount = parseFloat(document.getElementById('edit-amount')?.value);
                const desc = document.getElementById('edit-desc')?.value.trim();

                if (isNaN(amount) || amount <= 0 || !desc) {
                    alert('Invalid amount or description');
                    return;
                }

                userData.cashData[index] = {
                    ...userData.cashData[index],
                    type: typeVal,
                    amount,
                    desc
                };
            } else if (type === 'stock') {
                const name = document.getElementById('edit-name')?.value.trim();
                const qty = parseInt(document.getElementById('edit-qty')?.value);
                const price = parseFloat(document.getElementById('edit-price')?.value);

                if (!name || isNaN(qty) || qty < 0 || isNaN(price) || price < 0) {
                    alert('Invalid stock data');
                    return;
                }

                userData.stockData[index] = {
                    ...userData.stockData[index],
                    name,
                    qty,
                    price
                };
            }

            saveCurrentUserData();
            renderAll();
            viewModal.style.display = 'none';
            currentViewItem = null;
        });

        // Delete from view modal
        modalDelete.addEventListener('click', () => {
            if (!currentViewItem) return;
            viewModal.style.display = 'none';
            showDeleteConfirm(currentViewItem.type, currentViewItem.index);
        });

        modalClose.addEventListener('click', () => {
            viewModal.style.display = 'none';
            currentViewItem = null;
        });

        // ---------- DELETE CONFIRMATION MODAL ----------
        const deleteModal = document.getElementById('deleteModal');
        const confirmBtn = document.getElementById('confirmDelete');
        const cancelBtn = document.getElementById('cancelDelete');
        const deleteMsg = document.getElementById('delete-message');
        let pendingDelete = null;

        function showDeleteConfirm(type, index, extraMsg = '') {
            pendingDelete = { type, index };
            deleteMsg.innerText = extraMsg || `Delete this ${type} entry?`;
            deleteModal.style.display = 'flex';
        }

        confirmBtn.addEventListener('click', () => {
            if (!pendingDelete) return;
            const { type, index } = pendingDelete;
            if (type === 'credit') userData.creditData.splice(index, 1);
            else if (type === 'cash') userData.cashData.splice(index, 1);
            else if (type === 'stock') userData.stockData.splice(index, 1);
            
            saveCurrentUserData();
            renderAll();
            deleteModal.style.display = 'none';
            pendingDelete = null;
        });

        cancelBtn.addEventListener('click', () => {
            deleteModal.style.display = 'none';
            pendingDelete = null;
        });

        window.onclick = (e) => {
            if (e.target === viewModal) viewModal.style.display = 'none';
            if (e.target === deleteModal) deleteModal.style.display = 'none';
        };

        // ---------- UTILITIES ----------
        function updateDateDay() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date-day').innerText = `üìÖ ${now.toLocaleDateString(undefined, options)}`;
        }

        // ---------- RENDER FUNCTIONS ----------
        function renderAll() {
            renderHome();
            renderCredit();
            renderCash();
            renderStock();
            renderInvoicePreview();
        }

        function renderHome() {
            let totalCredit = userData.creditData.reduce((sum, c) => sum + c.amount, 0);
            let cashBalance = userData.cashData.reduce((sum, c) => sum + (c.type === 'income' ? c.amount : -c.amount), 0);
            let stockItems = userData.stockData.reduce((sum, s) => sum + s.qty, 0);
            let stockValue = userData.stockData.reduce((sum, s) => sum + (s.qty * s.price), 0);
            
            document.getElementById('home-total-credit').innerText = totalCredit;
            document.getElementById('home-cash-balance').innerText = cashBalance;
            document.getElementById('home-stock-items').innerText = stockItems;
            document.getElementById('home-stock-value').innerText = stockValue;
        }

        function renderCredit() {
            const listEl = document.getElementById('creditList');
            if (!listEl) return;
            let total = 0, collected = 0;
            let html = '';
            userData.creditData.forEach((c, idx) => {
                total += c.amount;
                if (c.collected) collected += c.amount;
                html += `<div class="list-item" onclick="window.openCreditView(${idx})">
                    <div><strong>${c.customer}</strong> <span class="badge">${c.note || ''}</span></div>
                    <div class="item-actions" onclick="event.stopPropagation()">
                        <span>LKR ${c.amount}</span>
                        <button class="btn-small" onclick="window.toggleCollected(${idx}); event.stopPropagation()">${c.collected ? '‚úÖ' : '‚≠ï'}</button>
                        <button class="delete-btn" onclick="window.showDeleteConfirm('credit', ${idx}); event.stopPropagation()">‚úñÔ∏è</button>
                    </div>
                </div>`;
            });
            listEl.innerHTML = html || '<p style="color:#94a3b8;">No credit entries. Click + to add.</p>';
            document.getElementById('totalCredit').innerText = total;
            document.getElementById('collectedCredit').innerText = collected;
            document.getElementById('remainingCredit').innerText = total - collected;
        }

        function renderCash() {
            const listEl = document.getElementById('cashList');
            if (!listEl) return;
            let balance = 0, todaySum = 0;
            const now = new Date();
            const startToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

            let html = '';
            userData.cashData.slice().reverse().forEach((c, idx) => {
                const amt = c.type === 'income' ? c.amount : -c.amount;
                balance += amt;
                if (c.timestamp >= startToday) todaySum += amt;
                const originalIdx = userData.cashData.length - 1 - idx;
                html += `<div class="list-item" onclick="window.openCashView(${originalIdx})">
                    <div><strong>${c.desc}</strong> <span class="badge">${new Date(c.timestamp).toLocaleDateString()}</span></div>
                    <div class="item-actions" onclick="event.stopPropagation()">
                        <span style="color:${c.type==='income'?'#0f7b4a':'#b91c1c'}">${c.type==='income'?'+':'-'} LKR ${c.amount}</span>
                        <button class="delete-btn" onclick="window.showDeleteConfirm('cash', ${originalIdx}); event.stopPropagation()">‚úñÔ∏è</button>
                    </div>
                </div>`;
            });
            listEl.innerHTML = html || '<p style="color:#94a3b8;">No cash entries. Click + to add.</p>';
            document.getElementById('todayCash').innerText = todaySum;
            document.getElementById('balanceCash').innerText = balance;
        }

        function renderStock() {
            const listEl = document.getElementById('stockList');
            if (!listEl) return;
            let totalItems = 0, totalValue = 0;
            let html = '';
            userData.stockData.forEach((s, idx) => {
                totalItems += s.qty;
                totalValue += s.qty * s.price;
                html += `<div class="list-item" onclick="window.openStockView(${idx})">
                    <div><strong>${s.name}</strong> (x${s.qty}) @ LKR ${s.price}</div>
                    <div class="item-actions" onclick="event.stopPropagation()">
                        <button class="delete-btn" onclick="window.showDeleteConfirm('stock', ${idx}); event.stopPropagation()">‚úñÔ∏è</button>
                    </div>
                </div>`;
            });
            listEl.innerHTML = html || '<p style="color:#94a3b8;">No stock. Click + to add.</p>';
            document.getElementById('totalItems').innerText = totalItems;
            document.getElementById('stockValue').innerText = totalValue;
        }

        function renderInvoicePreview() {
            const preview = document.getElementById('lastInvoicePreview');
            if (userData.lastInvoice) {
                preview.innerHTML = `<div class="list-item" onclick="window.openInvoiceView()">
                    <div><strong>${userData.lastInvoice.customer}</strong> ‚Äî ${userData.lastInvoice.date}</div>
                    <div>LKR ${userData.lastInvoice.total}</div>
                </div>`;
            } else {
                preview.innerHTML = '<p style="color:#64748b;">No invoice yet.</p>';
            }
        }

        // Global functions
        window.toggleCollected = (idx) => {
            userData.creditData[idx].collected = !userData.creditData[idx].collected;
            saveCurrentUserData();
            renderAll();
        };

        window.showDeleteConfirm = (type, idx) => {
            showDeleteConfirm(type, idx);
        };

        window.openCreditView = (idx) => {
            openViewModal('credit', idx);
        };

        window.openCashView = (idx) => {
            openViewModal('cash', idx);
        };

        window.openStockView = (idx) => {
            openViewModal('stock', idx);
        };

        window.openInvoiceView = () => {
            alert('Invoice view coming soon!');
        };

        // ---------- EVENT LISTENERS ----------
        document.addEventListener('DOMContentLoaded', () => {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-content'));
                    document.getElementById(btn.dataset.tab + '-tab').classList.add('active-content');
                });
            });

            // Credit add
            document.getElementById('addCreditBtn')?.addEventListener('click', () => {
                const cust = document.getElementById('credit-customer').value.trim();
                const amt = parseFloat(document.getElementById('credit-amount').value);
                const note = document.getElementById('credit-note').value.trim();
                if (!cust || isNaN(amt) || amt <= 0) { alert('Enter valid customer and amount'); return; }
                userData.creditData.push({ customer: cust, amount: amt, note: note, collected: false, timestamp: Date.now() });
                saveCurrentUserData(); renderAll();
                document.getElementById('credit-customer').value = ''; document.getElementById('credit-amount').value = ''; document.getElementById('credit-note').value = '';
            });

            // Cash add
            document.getElementById('addCashBtn')?.addEventListener('click', () => {
                const type = document.getElementById('cash-type').value;
                const amt = parseFloat(document.getElementById('cash-amount').value);
                const desc = document.getElementById('cash-desc').value.trim();
                if (isNaN(amt) || amt <= 0 || !desc) { alert('Enter valid amount and description'); return; }
                userData.cashData.push({ type, amount: amt, desc, timestamp: Date.now() });
                saveCurrentUserData(); renderAll();
                document.getElementById('cash-amount').value = ''; document.getElementById('cash-desc').value = '';
            });

            // Stock add
            document.getElementById('addStockBtn')?.addEventListener('click', () => {
                const name = document.getElementById('stock-name').value.trim();
                const qty = parseInt(document.getElementById('stock-qty').value);
                const price = parseFloat(document.getElementById('stock-price').value);
                if (!name || isNaN(qty) || qty <= 0 || isNaN(price) || price < 0) { alert('Enter valid details'); return; }
                userData.stockData.push({ name, qty, price });
                saveCurrentUserData(); renderAll();
                document.getElementById('stock-name').value = ''; document.getElementById('stock-qty').value = ''; document.getElementById('stock-price').value = '';
            });

            // Sell stock
            document.getElementById('sellStockBtn')?.addEventListener('click', () => {
                const name = document.getElementById('sell-item-name').value.trim();
                const qty = parseInt(document.getElementById('sell-qty').value);
                if (!name || isNaN(qty) || qty <= 0) { alert('Enter item and quantity'); return; }
                const itemIdx = userData.stockData.findIndex(s => s.name.toLowerCase() === name.toLowerCase());
                if (itemIdx === -1) { alert('Item not found'); return; }
                if (userData.stockData[itemIdx].qty < qty) { alert('Not enough stock'); return; }
                userData.stockData[itemIdx].qty -= qty;
                if (userData.stockData[itemIdx].qty === 0) userData.stockData.splice(itemIdx, 1);
                saveCurrentUserData(); renderAll();
                document.getElementById('sell-item-name').value = ''; document.getElementById('sell-qty').value = '';
            });

            // Invoice
            document.getElementById('createInvoiceBtn')?.addEventListener('click', () => {
                const cust = document.getElementById('invoice-customer').value.trim() || 'Walk-in';
                const items = document.getElementById('invoice-items').value.trim() || '‚Äî';
                const total = parseFloat(document.getElementById('invoice-total').value);
                if (isNaN(total)) { alert('Enter total'); return; }
                userData.lastInvoice = { customer: cust, items, total, date: new Date().toLocaleDateString() };
                saveCurrentUserData(); renderAll();
                alert('Invoice created!');
            });

            // Backup Download
            document.getElementById('backup-download').addEventListener('click', () => {
                const backup = {
                    user: currentUser,
                    data: userData,
                    backupDate: new Date().toISOString()
                };
                const dataStr = JSON.stringify(backup, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mytransactions-${currentUser?.split('@')[0]}-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            });

            // Restore
            document.getElementById('backup-upload').addEventListener('click', () => {
                document.getElementById('restore-file').click();
            });

            document.getElementById('restore-file').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const backup = JSON.parse(ev.target.result);
                        if (backup.data && backup.data.creditData !== undefined) {
                            userData.creditData = backup.data.creditData || [];
                            userData.cashData = backup.data.cashData || [];
                            userData.stockData = backup.data.stockData || [];
                            userData.lastInvoice = backup.data.lastInvoice || null;
                            saveCurrentUserData();
                            renderAll();
                            alert('Backup restored successfully!');
                        } else { alert('Invalid backup file'); }
                    } catch (err) { alert('Error reading backup'); }
                };
                reader.readAsText(file);
                e.target.value = '';
            });
        });
    })();
</script>
</body>
</html>
