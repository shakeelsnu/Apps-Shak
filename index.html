<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalBiz Books Pro üìíüí∞üì¶</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; }
        body {
            background: #f0f4f8;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 16px;
            color: #1e293b;
        }
        .app-container {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 32px 32px 24px 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        /* Login Page */
        .login-container {
            max-width: 400px;
            margin: 40px auto;
            padding: 32px;
            background: white;
            border-radius: 32px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            text-align: center;
        }
        .login-container h2 { color: #1a4a5f; margin-bottom: 8px; }
        .login-sub { color: #64748b; margin-bottom: 24px; font-size: 0.95rem; }
        .login-input {
            width: 100%;
            padding: 16px 18px;
            margin: 8px 0;
            border: 1.5px solid #e2e8f0;
            border-radius: 30px;
            font-size: 1rem;
        }
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 16px 0;
            justify-content: center;
        }
        .login-btn {
            background: #1a4a5f;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1.1rem;
            width: 100%;
            cursor: pointer;
            margin-top: 8px;
        }
        .demo-hint { font-size: 0.85rem; color: #94a3b8; margin-top: 20px; }
        /* Header */
        .app-header {
            background: linear-gradient(145deg, #0f2b3d, #1a4a5f);
            color: white;
            padding: 20px 24px;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        .app-header h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-welcome {
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(255,255,255,0.1);
            padding: 8px 16px;
            border-radius: 40px;
        }
        .logout-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.5);
            color: white;
            padding: 6px 16px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.2); }
        .date-day {
            font-size: 1rem;
            margin-top: 8px;
            opacity: 0.9;
        }
        /* Backup Bar */
        .backup-bar {
            background: #e9f2f5;
            padding: 12px 24px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #cbd5e1;
        }
        .backup-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .backup-btn {
            background: white;
            border: 1px solid #1a4a5f;
            color: #1a4a5f;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .backup-btn:hover { background: #1a4a5f; color: white; }
        /* Feature Tabs */
        .feature-tabs {
            display: flex;
            flex-wrap: wrap;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 0 8px;
        }
        .tab-btn {
            padding: 16px 20px;
            background: transparent;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            color: #1a4a5f;
            border-bottom-color: #1a4a5f;
            background: rgba(26, 74, 95, 0.04);
        }
        .tab-content {
            display: none;
            padding: 24px;
        }
        .tab-content.active-content { display: block; }
        /* Cards */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .card {
            background: #ffffff;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.02);
            border: 1px solid #eef2f6;
        }
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #0f2b3d;
        }
        .summary-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1a4a5f;
        }
        .summary-label { font-size: 0.9rem; color: #64748b; }
        .input-group { margin-bottom: 12px; }
        input, textarea, select {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid #e2e8f0;
            border-radius: 18px;
            font-size: 0.95rem;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #1a4a5f;
            box-shadow: 0 0 0 3px rgba(26,74,95,0.1);
        }
        .btn {
            background: #1a4a5f;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }
        .btn-secondary {
            background: white;
            color: #1a4a5f;
            border: 1px solid #1a4a5f;
        }
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            width: auto;
        }
        .list-item {
            background: #f8fafc;
            border-radius: 18px;
            padding: 14px 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #eef2f6;
        }
        .item-actions { display: flex; gap: 8px; }
        .delete-btn {
            background: #fee2e2;
            color: #b91c1c;
            border: none;
            padding: 6px 12px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .badge {
            background: #d9e6ed;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.8rem;
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: center;
        }
        .home-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }
        .stat-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 24px;
            text-align: center;
        }
    </style>
</head>
<body>
<div id="app">
    <!-- LOGIN SCREEN -->
    <div id="login-screen" style="display: none;">
        <div class="login-container">
            <h2>üìíüí∞üì¶ LocalBiz Books</h2>
            <div class="login-sub">Sign in to your offline account</div>
            <input type="email" id="login-email" class="login-input" placeholder="Email (any)" value="demo@shop.com">
            <input type="password" id="login-password" class="login-input" placeholder="Password (any)" value="password">
            <div class="checkbox-row">
                <input type="checkbox" id="remember-me" checked>
                <label for="remember-me">Remember me (auto-login next time)</label>
            </div>
            <button class="login-btn" id="login-btn">üîì Login</button>
            <div class="demo-hint">Use any email & password. Data stays on this device.</div>
        </div>
    </div>

    <!-- MAIN APP (shown after login) -->
    <div id="main-app" style="display: none;">
        <div class="app-header">
            <div class="header-top">
                <h1><span>üìíüí∞üì¶</span> LocalBiz Pro</h1>
                <div class="user-welcome">
                    <span id="welcome-user">üë§ Welcome, User</span>
                    <button class="logout-btn" id="logout-btn">üö™ Logout</button>
                </div>
            </div>
            <div class="date-day" id="current-date-day"></div>
        </div>

        <!-- Backup Bar (visible only after login) -->
        <div class="backup-bar">
            <span>üíæ Backup & Restore</span>
            <div class="backup-actions">
                <button class="backup-btn" id="backup-google-drive">‚òÅÔ∏è Backup to Google Drive (simulated)</button>
                <button class="backup-btn" id="backup-download">‚¨áÔ∏è Download Backup</button>
                <input type="file" id="restore-file" accept=".json" style="display: none;">
                <button class="backup-btn" id="backup-upload">‚¨ÜÔ∏è Restore from Backup</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="feature-tabs">
            <button class="tab-btn active" data-tab="home"><span>üè†</span> Home</button>
            <button class="tab-btn" data-tab="credit"><span>üìí</span> Credit Book</button>
            <button class="tab-btn" data-tab="cash"><span>üí∞</span> Cash Book</button>
            <button class="tab-btn" data-tab="stock"><span>üì¶</span> Stock Book</button>
            <button class="tab-btn" data-tab="invoice"><span>üßæ</span> Invoice</button>
        </div>

        <!-- HOME TAB -->
        <div id="home-tab" class="tab-content active-content">
            <div class="card">
                <div class="card-title">üìä Business Overview</div>
                <div class="home-stats" id="home-stats">
                    <div class="stat-card"><span class="summary-label">Total Credit</span><div class="summary-number" id="home-total-credit">0</div></div>
                    <div class="stat-card"><span class="summary-label">Cash Balance</span><div class="summary-number" id="home-cash-balance">0</div></div>
                    <div class="stat-card"><span class="summary-label">Stock Items</span><div class="summary-number" id="home-stock-items">0</div></div>
                    <div class="stat-card"><span class="summary-label">Stock Value</span><div class="summary-number" id="home-stock-value">0</div></div>
                </div>
                <p style="color: #64748b; margin-top: 8px;">‚ú® Your business at a glance. All data offline.</p>
            </div>
        </div>

        <!-- CREDIT BOOK TAB -->
        <div id="credit-tab" class="tab-content">
            <div class="feature-grid">
                <div class="card">
                    <div class="card-title">üìã New Credit</div>
                    <input type="text" id="credit-customer" placeholder="Customer name">
                    <input type="number" id="credit-amount" placeholder="Amount (LKR)">
                    <input type="text" id="credit-note" placeholder="Note">
                    <button class="btn" id="addCreditBtn">‚ûï Add Credit</button>
                </div>
                <div class="card">
                    <div class="card-title">üìä Summary</div>
                    <div style="display: flex; justify-content: space-between;">
                        <div><span class="summary-label">Total</span><div class="summary-number" id="totalCredit">0</div></div>
                        <div><span class="summary-label">Collected</span><div class="summary-number" id="collectedCredit">0</div></div>
                        <div><span class="summary-label">Remaining</span><div class="summary-number" id="remainingCredit">0</div></div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">üìú Credit Entries</div>
                <div id="creditList"></div>
            </div>
        </div>

        <!-- CASH BOOK TAB -->
        <div id="cash-tab" class="tab-content">
            <div class="feature-grid">
                <div class="card">
                    <div class="card-title">‚ûï Add Transaction</div>
                    <select id="cash-type"><option value="income">üí∞ Income</option><option value="expense">üí∏ Expense</option></select>
                    <input type="number" id="cash-amount" placeholder="Amount">
                    <input type="text" id="cash-desc" placeholder="Description">
                    <button class="btn" id="addCashBtn">Add Entry</button>
                </div>
                <div class="card">
                    <div class="card-title">üìà Cash Flow</div>
                    <div style="display: flex; justify-content: space-around;">
                        <div><span class="summary-label">Today</span><div class="summary-number" id="todayCash">0</div></div>
                        <div><span class="summary-label">Balance</span><div class="summary-number" id="balanceCash">0</div></div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">üìÜ Transactions</div>
                <div id="cashList"></div>
            </div>
        </div>

        <!-- STOCK BOOK TAB -->
        <div id="stock-tab" class="tab-content">
            <div class="feature-grid">
                <div class="card">
                    <div class="card-title">üì¶ Add Stock</div>
                    <input type="text" id="stock-name" placeholder="Item name">
                    <input type="number" id="stock-qty" placeholder="Quantity">
                    <input type="number" id="stock-price" placeholder="Cost price">
                    <button class="btn" id="addStockBtn">Add to Stock</button>
                </div>
                <div class="card">
                    <div class="card-title">üìä Stock Value</div>
                    <div><span class="summary-label">Total Items</span><div class="summary-number" id="totalItems">0</div></div>
                    <div><span class="summary-label">Est. Value</span><div class="summary-number" id="stockValue">0</div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">üìã Current Stock</div>
                <div id="stockList"></div>
                <div style="margin-top: 16px;">
                    <input type="text" id="sell-item-name" placeholder="Item to sell">
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="sell-qty" placeholder="Qty">
                        <button class="btn-small" id="sellStockBtn">Sell</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- INVOICE TAB -->
        <div id="invoice-tab" class="tab-content">
            <div class="feature-grid">
                <div class="card">
                    <div class="card-title">üßæ Create Invoice</div>
                    <input type="text" id="invoice-customer" placeholder="Customer">
                    <textarea id="invoice-items" placeholder="Items" rows="2"></textarea>
                    <input type="number" id="invoice-total" placeholder="Total">
                    <button class="btn" id="createInvoiceBtn">Generate</button>
                </div>
                <div class="card">
                    <div class="card-title">üìÑ Last Invoice</div>
                    <div id="lastInvoicePreview"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 16px;">‚ö†Ô∏è Confirm Delete</h3>
            <p id="delete-message">Are you sure you want to delete this item?</p>
            <div class="modal-actions">
                <button class="btn-small" id="confirmDelete">Yes, Delete</button>
                <button class="btn-small btn-secondary" id="cancelDelete">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        // ---------- STATE ----------
        let creditData = [];
        let cashData = [];
        let stockData = [];
        let lastInvoice = null;
        let currentUser = null;
        let pendingDelete = null; // { type, index }

        // ---------- INIT / LOAD FROM STORAGE ----------
        function loadAllData() {
            creditData = JSON.parse(localStorage.getItem('creditData')) || [];
            cashData = JSON.parse(localStorage.getItem('cashData')) || [];
            stockData = JSON.parse(localStorage.getItem('stockData')) || [];
            lastInvoice = JSON.parse(localStorage.getItem('lastInvoice')) || null;
        }
        function saveAllData() {
            localStorage.setItem('creditData', JSON.stringify(creditData));
            localStorage.setItem('cashData', JSON.stringify(cashData));
            localStorage.setItem('stockData', JSON.stringify(stockData));
            localStorage.setItem('lastInvoice', JSON.stringify(lastInvoice));
        }

        // ---------- LOGIN SYSTEM ----------
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const rememberMeCheck = document.getElementById('remember-me');
        const loginEmail = document.getElementById('login-email');
        const welcomeSpan = document.getElementById('welcome-user');

        // Check for saved login
        const savedUser = localStorage.getItem('rememberedUser');
        if (savedUser) {
            currentUser = savedUser;
            loginScreen.style.display = 'none';
            mainApp.style.display = 'block';
            welcomeSpan.innerText = `üë§ Welcome, ${savedUser.split('@')[0]}`;
            loadAllData();
            updateDateDay();
            renderAll();
        } else {
            loginScreen.style.display = 'block';
            mainApp.style.display = 'none';
        }

        document.getElementById('login-btn').addEventListener('click', () => {
            const email = loginEmail.value.trim() || 'demo@shop.com';
            const password = document.getElementById('login-password').value; // any password accepted
            if (!email) { alert('Enter email'); return; }
            currentUser = email;
            if (rememberMeCheck.checked) {
                localStorage.setItem('rememberedUser', email);
            } else {
                localStorage.removeItem('rememberedUser');
            }
            loginScreen.style.display = 'none';
            mainApp.style.display = 'block';
            welcomeSpan.innerText = `üë§ Welcome, ${email.split('@')[0]}`;
            loadAllData(); // Load existing data
            updateDateDay();
            renderAll();
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            currentUser = null;
            localStorage.removeItem('rememberedUser');
            loginScreen.style.display = 'block';
            mainApp.style.display = 'none';
            // Clear sensitive data from memory
            creditData = []; cashData = []; stockData = []; lastInvoice = null;
        });

        function updateDateDay() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date-day').innerText = `üìÖ ${now.toLocaleDateString(undefined, options)}`;
        }

        // ---------- DELETE CONFIRMATION MODAL ----------
        const modal = document.getElementById('deleteModal');
        const confirmBtn = document.getElementById('confirmDelete');
        const cancelBtn = document.getElementById('cancelDelete');
        const deleteMsg = document.getElementById('delete-message');

        function showDeleteConfirm(type, index, extraMsg = '') {
            pendingDelete = { type, index };
            deleteMsg.innerText = extraMsg || `Delete this ${type} entry?`;
            modal.style.display = 'flex';
        }

        confirmBtn.addEventListener('click', () => {
            if (!pendingDelete) return;
            const { type, index } = pendingDelete;
            if (type === 'credit') creditData.splice(index, 1);
            else if (type === 'cash') cashData.splice(index, 1);
            else if (type === 'stock') stockData.splice(index, 1);
            saveAllData();
            renderAll();
            modal.style.display = 'none';
            pendingDelete = null;
        });

        cancelBtn.addEventListener('click', () => {
            modal.style.display = 'none';
            pendingDelete = null;
        });

        window.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };

        // ---------- RENDER FUNCTIONS ----------
        function renderAll() {
            renderHome();
            renderCredit();
            renderCash();
            renderStock();
            renderInvoicePreview();
        }

        function renderHome() {
            // Calculate totals
            let totalCredit = creditData.reduce((sum, c) => sum + c.amount, 0);
            let cashBalance = cashData.reduce((sum, c) => sum + (c.type === 'income' ? c.amount : -c.amount), 0);
            let stockItems = stockData.reduce((sum, s) => sum + s.qty, 0);
            let stockValue = stockData.reduce((sum, s) => sum + (s.qty * s.price), 0);
            
            document.getElementById('home-total-credit').innerText = totalCredit;
            document.getElementById('home-cash-balance').innerText = cashBalance;
            document.getElementById('home-stock-items').innerText = stockItems;
            document.getElementById('home-stock-value').innerText = stockValue;
        }

        function renderCredit() {
            const listEl = document.getElementById('creditList');
            if (!listEl) return;
            let total = 0, collected = 0;
            let html = '';
            creditData.forEach((c, idx) => {
                total += c.amount;
                if (c.collected) collected += c.amount;
                html += `<div class="list-item">
                    <div><strong>${c.customer}</strong> <span class="badge">${c.note || ''}</span></div>
                    <div class="item-actions">
                        <span>LKR ${c.amount}</span>
                        <button class="btn-small" onclick="toggleCollected(${idx})">${c.collected ? '‚úÖ' : '‚≠ï'}</button>
                        <button class="delete-btn" onclick="showDeleteConfirm('credit', ${idx})">‚úñÔ∏è</button>
                    </div>
                </div>`;
            });
            listEl.innerHTML = html || '<p style="color:#94a3b8;">No credit entries.</p>';
            document.getElementById('totalCredit').innerText = total;
            document.getElementById('collectedCredit').innerText = collected;
            document.getElementById('remainingCredit').innerText = total - collected;
        }

        function renderCash() {
            const listEl = document.getElementById('cashList');
            if (!listEl) return;
            let balance = 0, todaySum = 0;
            const now = new Date();
            const startToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

            let html = '';
            cashData.slice().reverse().forEach((c, idx) => {
                const amt = c.type === 'income' ? c.amount : -c.amount;
                balance += amt;
                if (c.timestamp >= startToday) todaySum += amt;
                const originalIdx = cashData.length - 1 - idx; // for delete
                html += `<div class="list-item">
                    <div><strong>${c.desc}</strong> <span class="badge">${new Date(c.timestamp).toLocaleDateString()}</span></div>
                    <div class="item-actions">
                        <span style="color:${c.type==='income'?'#0f7b4a':'#b91c1c'}">${c.type==='income'?'+':'-'} LKR ${c.amount}</span>
                        <button class="delete-btn" onclick="showDeleteConfirm('cash', ${originalIdx})">‚úñÔ∏è</button>
                    </div>
                </div>`;
            });
            listEl.innerHTML = html || '<p style="color:#94a3b8;">No cash entries.</p>';
            document.getElementById('todayCash').innerText = todaySum;
            document.getElementById('balanceCash').innerText = balance;
        }

        function renderStock() {
            const listEl = document.getElementById('stockList');
            if (!listEl) return;
            let totalItems = 0, totalValue = 0;
            let html = '';
            stockData.forEach((s, idx) => {
                totalItems += s.qty;
                totalValue += s.qty * s.price;
                html += `<div class="list-item">
                    <div><strong>${s.name}</strong> (x${s.qty}) @ LKR ${s.price}</div>
                    <button class="delete-btn" onclick="showDeleteConfirm('stock', ${idx})">‚úñÔ∏è</button>
                </div>`;
            });
            listEl.innerHTML = html || '<p style="color:#94a3b8;">No stock.</p>';
            document.getElementById('totalItems').innerText = totalItems;
            document.getElementById('stockValue').innerText = totalValue;
        }

        function renderInvoicePreview() {
            const preview = document.getElementById('lastInvoicePreview');
            if (lastInvoice) {
                preview.innerHTML = `<p><strong>${lastInvoice.customer}</strong> ‚Äî ${lastInvoice.date}<br>Total: LKR ${lastInvoice.total}</p>`;
            } else {
                preview.innerHTML = '<p style="color:#64748b;">No invoice yet.</p>';
            }
        }

        // Toggle collected (global)
        window.toggleCollected = (idx) => {
            creditData[idx].collected = !creditData[idx].collected;
            saveAllData();
            renderAll();
        };
        window.showDeleteConfirm = (type, idx) => {
            showDeleteConfirm(type, idx);
        };

        // ---------- EVENT LISTENERS ----------
        document.addEventListener('DOMContentLoaded', () => {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-content'));
                    document.getElementById(btn.dataset.tab + '-tab').classList.add('active-content');
                });
            });

            // Credit add
            document.getElementById('addCreditBtn')?.addEventListener('click', () => {
                const cust = document.getElementById('credit-customer').value.trim();
                const amt = parseFloat(document.getElementById('credit-amount').value);
                const note = document.getElementById('credit-note').value.trim();
                if (!cust || isNaN(amt) || amt <= 0) { alert('Enter valid customer and amount'); return; }
                creditData.push({ customer: cust, amount: amt, note: note, collected: false, timestamp: Date.now() });
                saveAllData(); renderAll();
                document.getElementById('credit-customer').value = ''; document.getElementById('credit-amount').value = ''; document.getElementById('credit-note').value = '';
            });

            // Cash add
            document.getElementById('addCashBtn')?.addEventListener('click', () => {
                const type = document.getElementById('cash-type').value;
                const amt = parseFloat(document.getElementById('cash-amount').value);
                const desc = document.getElementById('cash-desc').value.trim();
                if (isNaN(amt) || amt <= 0 || !desc) { alert('Enter valid amount and description'); return; }
                cashData.push({ type, amount: amt, desc, timestamp: Date.now() });
                saveAllData(); renderAll();
                document.getElementById('cash-amount').value = ''; document.getElementById('cash-desc').value = '';
            });

            // Stock add
            document.getElementById('addStockBtn')?.addEventListener('click', () => {
                const name = document.getElementById('stock-name').value.trim();
                const qty = parseInt(document.getElementById('stock-qty').value);
                const price = parseFloat(document.getElementById('stock-price').value);
                if (!name || isNaN(qty) || qty <= 0 || isNaN(price) || price < 0) { alert('Enter valid details'); return; }
                stockData.push({ name, qty, price });
                saveAllData(); renderAll();
                document.getElementById('stock-name').value = ''; document.getElementById('stock-qty').value = ''; document.getElementById('stock-price').value = '';
            });

            // Sell stock
            document.getElementById('sellStockBtn')?.addEventListener('click', () => {
                const name = document.getElementById('sell-item-name').value.trim();
                const qty = parseInt(document.getElementById('sell-qty').value);
                if (!name || isNaN(qty) || qty <= 0) { alert('Enter item and quantity'); return; }
                const itemIdx = stockData.findIndex(s => s.name.toLowerCase() === name.toLowerCase());
                if (itemIdx === -1) { alert('Item not found'); return; }
                if (stockData[itemIdx].qty < qty) { alert('Not enough stock'); return; }
                stockData[itemIdx].qty -= qty;
                if (stockData[itemIdx].qty === 0) stockData.splice(itemIdx, 1);
                saveAllData(); renderAll();
                document.getElementById('sell-item-name').value = ''; document.getElementById('sell-qty').value = '';
            });

            // Invoice
            document.getElementById('createInvoiceBtn')?.addEventListener('click', () => {
                const cust = document.getElementById('invoice-customer').value.trim() || 'Walk-in';
                const items = document.getElementById('invoice-items').value.trim() || '‚Äî';
                const total = parseFloat(document.getElementById('invoice-total').value);
                if (isNaN(total)) { alert('Enter total'); return; }
                lastInvoice = { customer: cust, items, total, date: new Date().toLocaleDateString() };
                saveAllData(); renderAll();
                alert('Invoice created!');
            });

            // ---------- BACKUP FUNCTIONS ----------
            // Download backup
            document.getElementById('backup-download').addEventListener('click', () => {
                const backup = {
                    creditData, cashData, stockData, lastInvoice,
                    backupDate: new Date().toISOString(),
                    user: currentUser
                };
                const dataStr = JSON.stringify(backup, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `localbiz-backup-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            });

            // Restore from backup
            document.getElementById('backup-upload').addEventListener('click', () => {
                document.getElementById('restore-file').click();
            });

            document.getElementById('restore-file').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const backup = JSON.parse(ev.target.result);
                        if (backup.creditData && backup.cashData && backup.stockData) {
                            creditData = backup.creditData;
                            cashData = backup.cashData;
                            stockData = backup.stockData;
                            lastInvoice = backup.lastInvoice || null;
                            saveAllData();
                            renderAll();
                            alert('Backup restored successfully!');
                        } else { alert('Invalid backup file'); }
                    } catch (err) { alert('Error reading backup'); }
                };
                reader.readAsText(file);
                e.target.value = ''; // reset
            });

            // Google Drive simulation
            document.getElementById('backup-google-drive').addEventListener('click', () => {
                // Simulate Drive backup by downloading a file (since Drive API needs internet & auth)
                const backup = {
                    creditData, cashData, stockData, lastInvoice,
                    backupDate: new Date().toISOString(),
                    user: currentUser,
                    note: 'Simulated Google Drive backup (downloaded file)'
                };
                const dataStr = JSON.stringify(backup, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `drive-backup-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                alert('Simulated Google Drive backup: File downloaded. In a real app, this would sync to your Drive.');
            });
        });
    })();
</script>
</body>
</html>
